name: Build OpenWrt for Xiaomi AX3000T 24.10.3 - strongswan
on:
  workflow_dispatch:
  repository_dispatch:
  push:
    paths:
      - .github/workflows/OP24.10.3-strongswan.yml
      - config/xiaomi-ax3000t-strongswag24.10.3.config
      - scripts/**
    branches:
      - main
      - master

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: v24.10.3
  CONFIG_FILE: ${{ github.workspace }}/main-repo/config/xiaomi-ax3000t-strongswag24.10.3.config
  DIY_P1_SH: ${{ github.workspace }}/main-repo/diy-part1.sh
  DIY_P2_SH: ${{ github.workspace }}/main-repo/diy-part2.sh
  Part3_sh: ${{ github.workspace }}/main-repo/part3.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: æ¸…ç†ç¯å¢ƒ
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get autoremove -y
          sudo apt-get autoclean
          df -h

      - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache clang ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev libxml-parser-perl python3 python3-setuptools python3-pip python3-dev \
          unzip wget rsync subversion swig time xsltproc zlib1g-dev \
          software-properties-common lzma flex bison cmake xxd

      - name: ä¸‹è½½OpenWrtæºç 
        run: |
          echo "ä¸‹è½½OpenWrt 24.10ç‰ˆæœ¬..."
          git clone $REPO_URL -b $REPO_BRANCH --depth=1 openwrt
          cd openwrt
          echo "æºç ä¸‹è½½å®Œæˆ - ç‰ˆæœ¬ä¿¡æ¯:"
          git describe --tags || true

      # ===== ç¼“å­˜ï¼šdl / host / ccache / cargo =====
      - name: Cache dl
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-${{ runner.os }}-${{ env.REPO_BRANCH }}-${{ hashFiles('main-repo/config/**/*.config') }}
          restore-keys: |
            dl-${{ runner.os }}-${{ env.REPO_BRANCH }}-
            dl-${{ runner.os }}-

      - name: Cache host toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host
            openwrt/build_dir/host
          key: host-${{ runner.os }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            host-${{ runner.os }}-${{ env.REPO_BRANCH }}-
            host-${{ runner.os }}-

      - name: é…ç½®å¹¶ç¼“å­˜ ccache
        run: |
          mkdir -p $HOME/.ccache
          echo 'max_size = 2.0G' > $HOME/.ccache/ccache.conf
          echo 'compression = true' >> $HOME/.ccache/ccache.conf
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.ccache
          key: ccache-${{ runner.os }}-${{ env.REPO_BRANCH }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ env.REPO_BRANCH }}-
            ccache-${{ runner.os }}-

      - name: Cache Cargo (Rust)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: cargo-${{ runner.os }}-${{ env.REPO_BRANCH }}-${{ github.sha }}
          restore-keys: |
            cargo-${{ runner.os }}-${{ env.REPO_BRANCH }}-
            cargo-${{ runner.os }}-

      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬ä¸€éƒ¨åˆ†
        run: |
          cd openwrt
          if [ -f "$DIY_P1_SH" ]; then
            echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $DIY_P1_SH"
            chmod +x "$DIY_P1_SH"
            "$DIY_P1_SH"
          else
            echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: $DIY_P1_SH"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "æŸ¥æ‰¾æ–‡ä»¶: $(find ${{ github.workspace }} -name "diy-part1.sh" 2>/dev/null || true)"
          fi

      - name: æ›´æ–°feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "å®˜æ–¹feedså®‰è£…å®Œæˆ"

      - name: ç”Ÿæˆè®¾å¤‡é…ç½®
        run: |
          cd openwrt
          echo "é…ç½®å°ç±³AX3000T..."
          echo "é…ç½®æ–‡ä»¶è·¯å¾„: $CONFIG_FILE"
          if [ -f "$CONFIG_FILE" ]; then
            echo "ä½¿ç”¨å¤–éƒ¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"
            cp "$CONFIG_FILE" .config
            echo "é…ç½®æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            head -10 .config
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILEï¼Œç¼–è¯‘ç»ˆæ­¢"
            echo "æŸ¥æ‰¾æ–‡ä»¶:"
            find ${{ github.workspace }} -name "*.config" 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
            exit 1
          fi

      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬äºŒéƒ¨åˆ†
        run: |
          cd openwrt
          if [ -f "$DIY_P2_SH" ]; then
            echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $DIY_P2_SH"
            chmod +x "$DIY_P2_SH"
            "$DIY_P2_SH"
          else
            echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: $DIY_P2_SH"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "æŸ¥æ‰¾æ–‡ä»¶: $(find ${{ github.workspace }} -name "diy-part2.sh" 2>/dev/null || true)"
          fi

      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬ä¸‰éƒ¨åˆ†
        run: |
          cd openwrt
          if [ -f "$Part3_sh" ]; then
            echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $Part3_sh"
            chmod +x "$Part3_sh"
            "$Part3_sh"
          else
            echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: $Part3_sh"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "æŸ¥æ‰¾æ–‡ä»¶: $(find ${{ github.workspace }} -name "part3.sh" 2>/dev/null || true)"
          fi

      # ===== é¢„ä¸‹è½½å¹¶å‘ + å®¹é”™ =====
      - name: ä¸‹è½½æºç åŒ…
        run: |
          cd openwrt
          echo "ğŸ› ï¸ ä¿®å¤é…ç½®æ–‡ä»¶"
          make defconfig
          echo "ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…..."
          make download -j"$(nproc)" IGNORE_ERRORS=1
          find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true
          echo "ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    # ===== Rust bootstrap é¢„å‡†å¤‡å¹¶è¡¥ä¸ï¼šç»Ÿä¸€ä¸º download-ci-llvm = "if-unchanged" =====
      - name: é¢„å‡†å¤‡å¹¶ä¿®è¡¥ Rust bootstrapï¼ˆç»Ÿä¸€åˆ° if-unchangedï¼‰        
        run: |
          cd openwrt
          make package/feeds/packages/rust/host/clean V=s || true
          make package/feeds/packages/rust/host/prepare V=s
          CFG=$(grep -RslE '(^|[[:space:]])download-ci-llvm(-if-unchanged)?[[:space:]]*=' build_dir/host 2>/dev/null | head -n1 || true) 

          if [ -n "$CFG" ]; then
          echo "patch: $CFG"
          sed -Ei \
          -e 's/^[[:space:]]*download-ci-llvm-if-unchanged[[:space:]]*=[[:space:]]*true[[:space:]]*$/download-ci-llvm = "if-unchanged"/' \
          -e 's/^[[:space:]]*download-ci-llvm[[:space:]]*=[[:space:]]*true[[:space:]]*$/download-ci-llvm = "if-unchanged"/' \
          "$CFG"

          echo "after patch:"
          grep -n 'download-ci-llvm' "$CFG" || true
          else
          echo "WARN: æœªæ‰¾åˆ° rust config.tomlï¼Œåç»­å°†ç”± unset CI å…œåº•ã€‚"
          fi


      # ===== ç¼–è¯‘ï¼ˆå¯¹å­è¿›ç¨‹éšè— CIï¼›å¤±è´¥å†å•çº¿ç¨‹ + V=sï¼‰ =====
      - name: ç¼–è¯‘ OpenWrt å›ºä»¶ï¼ˆå¤±è´¥å†å¼€ V=sï¼‰
        timeout-minutes: 360
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache
          CC: "ccache gcc"
          CXX: "ccache g++"
          FORCE_UNSAFE_CONFIGURE: "1"
        run: |
          cd openwrt
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ OpenWrt for å°ç±³ AX3000T"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          CORES=$(nproc)
          echo "ä½¿ç”¨ ${CORES} çº¿ç¨‹ç¼–è¯‘"
          free -h
          echo "ğŸ“¦ ç¼–è¯‘ä¸­..."
          if ! (unset CI; make -j${CORES}); then
            echo "âš ï¸ å¹¶è¡Œå¤±è´¥ï¼Œå•çº¿ç¨‹ + è¯¦ç»†æ—¥å¿—é‡è¯•"
            (unset CI; make -j1 V=s)
          fi
          echo "âœ… ç¼–è¯‘ç»“æŸæ—¶é—´: $(date)"
          if [ -d "bin/targets/mediatek/filogic" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼å›ºä»¶ç›®å½•å¦‚ä¸‹ï¼š"
            ls -la bin/targets/mediatek/filogic/
            echo "COMPILE_SUCCESS=true" >> $GITHUB_ENV
            echo "FIRMWARE_PATH=$(pwd)/bin/targets/mediatek/filogic" >> $GITHUB_ENV
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªæ‰¾åˆ°å›ºä»¶è¾“å‡ºç›®å½•"
            find bin/targets -type d 2>/dev/null || echo "æœªæ‰¾åˆ° targets ç›®å½•"
            exit 1
          fi

      - name: æ£€æŸ¥å›ºä»¶åŒ…å«çš„è½¯ä»¶åŒ…
        if: env.COMPILE_SUCCESS == 'true'
        run: |
          cd ${{ env.FIRMWARE_PATH }}
          echo "=== æ£€æŸ¥ç¼–è¯‘å‡ºçš„å›ºä»¶åŒ…å«çš„ strongswan ç›¸å…³æ–‡ä»¶ ==="
          if [ -f "packages.txt" ]; then
            echo "å›ºä»¶åŒ…å«çš„ strongswan ç›¸å…³åŒ…:"
            grep -i strongswan packages.txt || echo "âŒ å›ºä»¶ä¸­æœªåŒ…å« strongswan"
          fi
          for bin_file in *.bin; do
            if [ -f "$bin_file" ]; then
              echo "æ£€æŸ¥ $bin_file çš„å¤§å°å’Œæ—¶é—´æˆ³ï¼š"
              ls -lh "$bin_file"
            fi
          done

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        if: env.COMPILE_SUCCESS == 'true'
        run: |
          cd ${{ env.FIRMWARE_PATH }}
          echo "æ•´ç†å›ºä»¶æ–‡ä»¶..."
          rm -rf packages
          find . -name "*.md5sum" -delete
          find . -name "*.sha256sum" -delete
          find . -name "*.md5" -delete
          find . -name "*.sha256" -delete
          echo "æœ€ç»ˆå›ºä»¶æ–‡ä»¶ï¼š"
          ls -lh *.bin 2>/dev/null || echo "æœªæ‰¾åˆ°binæ–‡ä»¶"

      - name: è·å–å½“å‰æ—¥æœŸï¼ˆç”¨äº tagï¼‰
        id: build_date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: è·å–å½“å‰æ—¶é—´ï¼ˆç”¨äºæ­£æ–‡ï¼‰
        id: date
        run: echo "date=$(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºRelease
        if: env.COMPILE_SUCCESS == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: openwrt-24.10-${{ github.run_number }}-${{ steps.build_date.outputs.date }}
          name: å°ç±³AX3000T OpenWrt 24.10.3 - Build ${{ github.run_number }}
          body: |
            ğŸ‰ **å°ç±³AX3000T OpenWrt 24.10.3 å›ºä»¶**
            ğŸ“¦ **å›ºä»¶ä¿¡æ¯**:
            - ğŸ”§ åŸºäº: OpenWrt 24.10.3 å®˜æ–¹ç‰ˆæœ¬
            - ğŸ“… ç¼–è¯‘æ—¶é—´: ${{ steps.date.outputs.date }}
            - ğŸ”¢ æ„å»ºç¼–å·: #${{ github.run_number }}
            - ğŸ  é»˜è®¤åœ°å€: http://10.0.0.1
            - ğŸ‘¤ é»˜è®¤è´¦æˆ·: root (å¯†ç ä¸ºç©º)
            âœ… **åŒ…å«åŠŸèƒ½**:
            - ğŸ“¡ å®Œæ•´è·¯ç”±å™¨åŠŸèƒ½
            - ğŸ“¶ Wi-Fi 6 åŒé¢‘æ”¯æŒ
            - ğŸŒ LuCI Web ç®¡ç†ç•Œé¢
            - ğŸ”’ IPSec VPN æœåŠ¡å™¨ (strongSwan)
            - å…¨åŠŸèƒ½ç‰ˆ DNSMASQ
            ğŸ“‹ **ä½¿ç”¨è¯´æ˜**:
            1. ç¡®è®¤è®¾å¤‡å‹å·ä¸ºå°ç±³ AX3000T v1
            2. åˆ·æœºå‰åŠ¡å¿…å¤‡ä»½åŸå‚å›ºä»¶
            3. åˆ·å…¥å›ºä»¶åè®¿é—® http://10.0.0.1
            4. ç”¨æˆ·å: rootï¼Œå¯†ç ä¸ºç©º
            âš ï¸ **é‡è¦æé†’**:
            - é€‚ç”¨äºå°ç±³ AX3000T v1 (MT7981 èŠ¯ç‰‡)
            - åˆ·æœºæœ‰é£é™©ï¼Œè¯·ç¡®ä¿äº†è§£åˆ·æœºæµç¨‹
          files: |
            ${{ env.FIRMWARE_PATH }}/*
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ç¼–è¯‘æ€»ç»“
        if: always()
        run: |
          echo "========================================="
          echo "           ç¼–è¯‘æ€»ç»“æŠ¥å‘Š"
          echo "========================================="
          echo "çŠ¶æ€: ${{ env.COMPILE_SUCCESS == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
          echo "æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ç‰ˆæœ¬: OpenWrt 24.10.3"
          echo "è®¾å¤‡: å°ç±³AX3000T v1"
          echo "æ„å»º: #${{ github.run_number }}"
          if [ "${{ env.COMPILE_SUCCESS }}" == "true" ]; then
            echo "å›ºä»¶: ${{ env.FIRMWARE_PATH }}"
            echo "ğŸ‰ æ­å–œï¼å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            echo "ğŸ“¥ ä¸‹è½½åœ°å€: ${{ github.server_url }}/${{ github.repository }}/releases/latest"
          else
            echo "ğŸ˜ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"
          fi
          echo "========================================="

name: Build OpenWrt for strongswan8g

on:
  workflow_dispatch:
  repository_dispatch:
  push:
    paths:
      - .github/workflows/**
      - config/**
      - scripts/**
    branches:
      - main
      - master

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: v24.10.2
  CONFIG_FILE: ${{ github.workspace }}/main-repo/config/strongswan.config
  DIY_P1_SH: ${{ github.workspace }}/main-repo/diy-part1.sh
  DIY_P2_SH: ${{ github.workspace }}/main-repo/diy-part2.sh
  Part3_sh: ${{ github.workspace }}/main-repo/part3.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: æ¸…ç†ç¯å¢ƒ
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get autoremove -y
          sudo apt-get autoclean
          df -h
      - name: æ¸…ç†ä¹‹å‰çš„æ„å»º (distclean)
        run: |
          # å°è¯•ä¸åŒçš„å¯èƒ½è·¯å¾„
          if [ -d "openwrt" ]; then
          echo "æ‰¾åˆ°openwrtç›®å½•ï¼Œæ‰§è¡Œdistclean"
          cd openwrt
          make distclean
          elif [ -d "OpenWRT_AutoBuild/openwrt" ]; then
          echo "æ‰¾åˆ°OpenWRT_AutoBuild/openwrtç›®å½•ï¼Œæ‰§è¡Œdistclean"
          cd OpenWRT_AutoBuild/openwrt
          make distclean
          else
          echo "æœªæ‰¾åˆ°openwrtç›®å½•ï¼Œè·³è¿‡distclean"
          fi


#      - name: å¢åŠ swapç©ºé—´
#        run: |
#          echo "å¢åŠ 8GB swapç©ºé—´..."
#          sudo fallocate -l 8G /swapfile
#          sudo chmod 600 /swapfile
#          sudo mkswap /swapfile
#          sudo swapon /swapfile
#          free -h

      - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache clang ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev libxml-parser-perl python3 python3-setuptools python3-pip python3-dev \
          python3-pyelftools unzip wget rsync subversion swig time xsltproc \
          zlib1g-dev zlib1g-dev software-properties-common \
          lzma flex bison cmake xxd

      - name: ä¸‹è½½OpenWrtæºç 
        run: |
          echo "ä¸‹è½½OpenWrt 24.10ç‰ˆæœ¬..."
          git clone $REPO_URL -b $REPO_BRANCH --depth=1
          cd openwrt
          git describe --tags

      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬ä¸€éƒ¨åˆ†
        run: |
          cd openwrt
          if [ -f "$DIY_P1_SH" ]; then
            chmod +x "$DIY_P1_SH"
            "$DIY_P1_SH"
          fi
          
      - name: æ›´æ–°feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ç”Ÿæˆè®¾å¤‡é…ç½®
        run: |
          cd openwrt
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" .config
          fi
          make defconfig

      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬äºŒéƒ¨åˆ†
        run: |
          cd openwrt
          if [ -f "$DIY_P2_SH" ]; then
            chmod +x "$DIY_P2_SH"
            "$DIY_P2_SH"
          fi

      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬ä¸‰éƒ¨åˆ†
        run: |
          cd openwrt
          if [ -f "$Part3_sh" ]; then
            chmod +x "$Part3_sh"
            "$Part3_sh"
          fi

      - name: ä¸‹è½½æºç åŒ…
        run: |
          cd openwrt
          make download -j4
          find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          echo "å¼€å§‹ç¼–è¯‘ OpenWrt 24.10 for å°ç±³AX3000T"
          export FORCE_UNSAFE_CONFIGURE=1
          COMPILE_THREADS=$(nproc)
          echo "ä½¿ç”¨ ${COMPILE_THREADS} çº¿ç¨‹ç¼–è¯‘"
          make -j${COMPILE_THREADS} V=s || make -j1 V=s
          if [ -d "bin/targets/mediatek/filogic" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
            ls -la bin/targets/mediatek/filogic/
            echo "COMPILE_SUCCESS=true" >> $GITHUB_ENV
            echo "FIRMWARE_PATH=$(pwd)/bin/targets/mediatek/filogic" >> $GITHUB_ENV
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        if: env.COMPILE_SUCCESS == 'true'
        run: |
          cd ${{ env.FIRMWARE_PATH }}
          rm -rf packages
          find . -name "*.md5sum" -delete
          find . -name "*.sha256sum" -delete
          echo "æœ€ç»ˆå›ºä»¶æ–‡ä»¶ï¼š"
          ls -lh *.bin 2>/dev/null || echo "æœªæ‰¾åˆ°binæ–‡ä»¶"

      - name: è·å–å½“å‰æ—¥æœŸ
        id: build_date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºRelease
        if: env.COMPILE_SUCCESS == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: openwrt-24.10-${{ github.run_number }}-${{ steps.build_date.outputs.date }}
          name: å°ç±³AX3000T OpenWrt 24.10 - Build ${{ github.run_number }}
          body: |
            ğŸ‰ **å°ç±³AX3000T OpenWrt 24.10 å›ºä»¶**
            - åŸºäº OpenWrt 24.10 å®˜æ–¹ç‰ˆæœ¬
            - é»˜è®¤åœ°å€: http://10.0.0.1
            - ç”¨æˆ·å: rootï¼Œå¯†ç ä¸ºç©º
            - åŒ…å« strongSwan IPSec VPN
          files: |
            ${{ env.FIRMWARE_PATH }}/*
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ç¼–è¯‘æ€»ç»“
        if: always()
        run: |
          echo "========================================="
          echo "           ç¼–è¯‘æ€»ç»“æŠ¥å‘Š"
          echo "========================================="
          echo "çŠ¶æ€: ${{ env.COMPILE_SUCCESS == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
          echo "ç‰ˆæœ¬: OpenWrt 24.10"
          echo "è®¾å¤‡: å°ç±³AX3000T v1"
          echo "æ„å»º: #${{ github.run_number }}"
          if [ "${{ env.COMPILE_SUCCESS }}" == "true" ]; then
            echo "å›ºä»¶ç›®å½•: ${{ env.FIRMWARE_PATH }}"
            echo "ğŸ‰ ç¼–è¯‘æˆåŠŸ"
          else
            echo "ğŸ˜ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
          echo "========================================="

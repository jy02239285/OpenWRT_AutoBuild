name: Build OpenWrt for Xiaomi AX3000T 24.10.4v2 - strongswan - AdGuard Home
on:
  workflow_dispatch:
  repository_dispatch:
  push:
    paths:
      - .github/workflows/OpenWRT24.10.4-strongswan-ADGuardv2.yml 
      - config/xiaomi-ax3000t-strongswan24.10.4v2.config
      - scripts/**
    branches:
      - main
      - master
env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: v24.10.3
  CONFIG_FILE: ${{ github.workspace }}/main-repo/config/xiaomi-ax3000t-strongswan24.10.4v2.config
  DIY_P1_SH: ${{ github.workspace }}/main-repo/diy-part1.sh
  DIY_P2_SH: ${{ github.workspace }}/main-repo/diy-part2.sh
  Part3_sh: ${{ github.workspace }}/main-repo/part3.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: main-repo
          
      - name: æ¸…ç†ç¯å¢ƒ
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get autoremove -y
          sudo apt-get autoclean
          df -h
          
      - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache clang ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev libxml-parser-perl python3 python3-setuptools python3-pip python3-dev \
          unzip wget rsync subversion swig time xsltproc zlib1g-dev \
          software-properties-common lzma flex bison cmake xxd
          
      - name: ä¸‹è½½OpenWrtæºç 
        run: |
          echo "ä¸‹è½½OpenWrt 24.10ç‰ˆæœ¬..."
          git clone $REPO_URL -b $REPO_BRANCH --depth=1
          cd openwrt
          echo "æºç ä¸‹è½½å®Œæˆ - ç‰ˆæœ¬ä¿¡æ¯:"
          git describe --tags
          
      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬ä¸€éƒ¨åˆ†
        run: |
          cd openwrt
          if [ -f "$DIY_P1_SH" ]; then
            echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $DIY_P1_SH"
            chmod +x "$DIY_P1_SH"
            "$DIY_P1_SH"
          else
            echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: $DIY_P1_SH"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "æŸ¥æ‰¾æ–‡ä»¶: $(find ${{ github.workspace }} -name "diy-part1.sh" 2>/dev/null || true)"
          fi
      - name: è¿½åŠ ç¬¬ä¸‰æ–¹ feedsï¼ˆOpenClash/Passwall2/AdGuardHome/SoftEtherï¼‰
        working-directory: openwrt
        shell: bash
        run: |
          set -e
          echo ">> è¿½åŠ ç¬¬ä¸‰æ–¹ feeds åˆ° feeds.conf.default å°¾éƒ¨"
          {
            printf '\n# ===== Appended third-party feeds =====\n'
            echo 'src-git openclash https://github.com/vernesong/OpenClash.git'
            echo 'src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main'
            echo 'src-git passwall_luci     https://github.com/xiaorouji/openwrt-passwall2.git;main'
            echo 'src-git adguardhome_luci  https://github.com/rufengsuixing/luci-app-adguardhome.git'
            echo 'src-git routing https://git.openwrt.org/feed/routing.git^3eb59e9471858c83891979793f1dd29cca156919'
            echo 'src-git telephony https://git.openwrt.org/feed/telephony.git^2a4541d46199ac96fac214d02c908402831c4dc6'
            echo 'src-git helloworld https://github.com/v2support/helloworld.git'
            echo 'src-git small https://github.com/v2support/small-package.git'
          } >> feeds.conf.default
          echo ">> é¢„è§ˆ feeds.conf.default æœ«å°¾ï¼š"
          tail -n 30 feeds.conf.default
          
      - name: æ›´æ–°feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "å®˜æ–¹åŠç¬¬ä¸‰æ–¹ feeds å®‰è£…å®Œæˆ"
          
      - name: ç”Ÿæˆè®¾å¤‡é…ç½®
        run: |
           cd openwrt
           echo "é…ç½®å°ç±³AX3000T..."
           echo "é…ç½®æ–‡ä»¶è·¯å¾„: $CONFIG_FILE"
    
           if [ -f "$CONFIG_FILE" ]; then
           echo "ä½¿ç”¨å¤–éƒ¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"
           cp "$CONFIG_FILE" .config
           echo "é…ç½®æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
           head -10 .config
           else
           echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILEï¼Œç¼–è¯‘ç»ˆæ­¢"
           echo "æŸ¥æ‰¾æ–‡ä»¶:"
           find ${{ github.workspace }} -name "*.config" 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
           exit 1
           fi
                    
      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬äºŒéƒ¨åˆ†
        run: |
          cd openwrt
          if [ -f "$DIY_P2_SH" ]; then
            echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $DIY_P2_SH"
            chmod +x "$DIY_P2_SH"
            "$DIY_P2_SH"
          else
            echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: $DIY_P2_SH"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "æŸ¥æ‰¾æ–‡ä»¶: $(find ${{ github.workspace }} -name "diy-part2.sh" 2>/dev/null || true)"
          fi
          
      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬ä¸‰éƒ¨åˆ†
        run: |
          cd openwrt
          if [ -f "$Part3_sh" ]; then
            echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $Part3_sh"
            chmod +x "$Part3_sh"
            "$Part3_sh"
          else
            echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: $Part3_sh"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "æŸ¥æ‰¾æ–‡ä»¶: $(find ${{ github.workspace }} -name "part3.sh" 2>/dev/null || true)"
          fi
          
      - name: ä¸‹è½½æºç åŒ…
        run: |
          cd openwrt
          echo "ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…..."
          make download -j4
          find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true
          echo "ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"
      - name: ç¼–è¯‘ OpenWRT å›ºä»¶
        run: |
          cd openwrt
          echo "ğŸ› ï¸ ä¿®å¤é…ç½®æ–‡ä»¶"
          make defconfig
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ OpenWRT for å°ç±³ AX3000T"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          export FORCE_UNSAFE_CONFIGURE=1
          COMPILE_THREADS=4
          echo "ä½¿ç”¨ ${COMPILE_THREADS} çº¿ç¨‹ç¼–è¯‘"
          free -h
          echo "ğŸ“¦ ç¼–è¯‘ä¸­..."
          if ! make -j${COMPILE_THREADS} V=s; then
          echo "âš ï¸ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹è°ƒè¯•æ¨¡å¼..."
          make -j1 V=s
          exit 1
          fi
          echo "âœ… ç¼–è¯‘ç»“æŸæ—¶é—´: $(date)"
          if [ -d "bin/targets/mediatek/filogic" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼å›ºä»¶ç›®å½•å¦‚ä¸‹ï¼š"
          ls -la bin/targets/mediatek/filogic/
          echo "COMPILE_SUCCESS=true" >> $GITHUB_ENV
          echo "FIRMWARE_PATH=$(pwd)/bin/targets/mediatek/filogic" >> $GITHUB_ENV
          else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªæ‰¾åˆ°å›ºä»¶è¾“å‡ºç›®å½•"
          find bin/targets -type d 2>/dev/null || echo "æœªæ‰¾åˆ° targets ç›®å½•"
          exit 1
          fi
          
      - name: æ£€æŸ¥å›ºä»¶åŒ…å«çš„è½¯ä»¶åŒ…
        if: env.COMPILE_SUCCESS == 'true'
        run: |
          cd ${{ env.FIRMWARE_PATH }}
          echo "=== æ£€æŸ¥ç¼–è¯‘å‡ºçš„å›ºä»¶åŒ…å«çš„strongswanç›¸å…³æ–‡ä»¶ ==="
          if [ -f "packages.txt" ]; then
            echo "å›ºä»¶åŒ…å«çš„strongswanç›¸å…³åŒ…:"
            grep -i strongswan packages.txt || echo "âŒ å›ºä»¶ä¸­æœªåŒ…å«strongswan"
          fi
          
          # æ£€æŸ¥å›ºä»¶æ–‡ä»¶
          for bin_file in *.bin; do
            if [ -f "$bin_file" ]; then
              echo "æ£€æŸ¥ $bin_file çš„å¤§å°å’Œæ—¶é—´æˆ³ï¼š"
              ls -lh "$bin_file"
            fi
          done
          
      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        if: env.COMPILE_SUCCESS == 'true'
        run: |
          cd ${{ env.FIRMWARE_PATH }}
          echo "æ•´ç†å›ºä»¶æ–‡ä»¶..."
          rm -rf packages
          find . -name "*.md5sum" -delete
          find . -name "*.sha256sum" -delete
          find . -name "*.md5" -delete
          find . -name "*.sha256" -delete
          echo "æœ€ç»ˆå›ºä»¶æ–‡ä»¶ï¼š"
          ls -lh *.bin 2>/dev0 || echo "æœªæ‰¾åˆ°binæ–‡ä»¶"
          
      - name: è·å–å½“å‰æ—¥æœŸ
        id: build_date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        
      - name: è·å–ç³»ç»Ÿä¿¡æ¯
        id: system_info
        run: |
          OS_INFO=$(cat /etc/os-release | grep PRETTY_NAME | cut -d '"' -f2)
          echo "os_info=${OS_INFO}" >> $GITHUB_OUTPUT
          
      - name: åˆ›å»ºRelease
        if: env.COMPILE_SUCCESS == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: openwrt-24.10-${{ github.run_number }}-${{
            steps.build_date.outputs.date }}
          name: å°ç±³AX3000T OpenWrt 24.10.3 - Build ${{ github.run_number }}
          body: |
            ğŸ‰ å°ç±³ AX3000T OpenWrt 24.10.3 å›ºä»¶
            ğŸ“¦ å›ºä»¶ä¿¡æ¯
            ğŸ”§ åŸºäºï¼šOpenWrt 24.10.3 å®˜æ–¹ç‰ˆæœ¬ï¼ˆå†…æ ¸ 6.6ï¼‰
            ğŸ“… ç¼–è¯‘æ—¶é—´ï¼š${{ steps.date.outputs.date }}
            ğŸ”¢ æ„å»ºç¼–å·ï¼š#${{ github.run_number }}
            ğŸ  é»˜è®¤åœ°å€ï¼šhttp://10.0.0.1
            ğŸ‘¤ é»˜è®¤è´¦æˆ·ï¼šrootï¼ˆå¯†ç ä¸ºç©ºï¼‰
            ğŸŒ ç®¡ç†ç•Œé¢ï¼šLuCIï¼ˆä¸­æ–‡åŒ…ï¼‰ï¼ŒNginx + luci-ssl-nginxï¼ˆå·²å¯ç”¨ HTTPS æ”¯æŒï¼‰
            âœ… åŒ…å«åŠŸèƒ½
            ğŸ“¡ å®Œæ•´è·¯ç”±å™¨åŠŸèƒ½ï¼ˆIPv4/IPv6ã€PPPoEã€DHCPv4/v6ã€DNSSECã€TFTPã€IPSet ç­‰ï¼‰
            ğŸ“¶ Wi-Fi 6 åŒé¢‘ï¼ˆmt7915e/mt7981 å›ºä»¶ï¼Œå« 802.11s Meshï¼‰ï¼Œwpad-opensslï¼ˆWPA2/WPA3/802.1Xï¼‰
            ğŸ”’ IPsec VPN æœåŠ¡å™¨ï¼ˆstrongSwan-fullï¼‰ï¼ŒSoftEther VPNï¼ˆserver/server-bridgeï¼‰
            ğŸš¦ ä»£ç†/åˆ†æµå¥—ä»¶ï¼šOpenClashã€Passwall2ã€sing-boxï¼ˆClash API/QUIC/ECH/uTLS/WGï¼‰ã€Xray-coreã€Hysteriaã€Shadowsocks/SSRï¼ˆå« ss/ssr-redirï¼‰
            ğŸ§  DNS & å»å¹¿å‘Šï¼šAdGuardHomeã€dnsmasq-fullã€chinadns-ngã€geodataï¼ˆgeoip/geositeï¼‰
            âš¡ åŠ é€Ÿä¸è½¬å‘ï¼šMediaTek HNATã€Flow Offloadã€FullCone NATã€BBRã€UPnPï¼ˆminiupnpdï¼‰
            ğŸ“ æ–‡ä»¶å…±äº«ä¸å­˜å‚¨ï¼šSamba4ï¼ˆ+ wsdd2ï¼‰ã€vsftpd-altã€Rcloneï¼ˆWebUI/ngï¼‰ã€ext4/f2fs/NTFS3/exFAT/NFS/CIFS ç­‰
            ğŸ“Š ç›‘æ§ä¸ç»Ÿè®¡ï¼šnlbwmonã€collectdï¼ˆCPU/å†…å­˜/æ¥å£/æ— çº¿ç­‰ï¼‰
            ğŸ§° è¿ç»´å·¥å…·ï¼šttyd Web ç»ˆç«¯ã€curl/wget-ssl/tcpdump/iperf3/nmap-ssl/ethtool ç­‰
            ğŸ—œï¸ ç³»ç»Ÿä¼˜åŒ–ï¼šZRAM-swapã€CoreMark å¤šçº¿ç¨‹ã€åŒ…ç­¾åæ ¡éªŒã€ASLR/RELRO/Stack Protector
            ğŸ–¥ï¸ LuCI ä¸»è¦å…¥å£ï¼ˆç¤ºä¾‹ï¼‰
            æœåŠ¡ï¼šOpenClash / Passwall2 / sing-box / AdGuardHome / SoftEther / Samba / Rclone / FTP / TTYD
            ç½‘ç»œï¼šé˜²ç«å¢™ / UPnP / DDNS / TurboACCï¼ˆå« Flow Offload/BBR/FullConeï¼‰
            ç»Ÿè®¡ï¼šæµé‡ç»Ÿè®¡ï¼ˆnlbwmonï¼‰
            ğŸ“‹ ä½¿ç”¨è¯´æ˜
            ç¡®è®¤è®¾å¤‡å‹å·ä¸º å°ç±³ AX3000T v1ï¼ˆMT7981ï¼‰ã€‚
            åˆ·æœºå‰åŠ¡å¿…å¤‡ä»½åŸå‚åˆ†åŒº/é…ç½®ã€‚
            åˆ·å…¥åè®¿é—® http://10.0.0.1
            è´¦æˆ· root / å¯†ç ç©ºï¼ˆè¯·ç«‹å³ä¿®æ”¹ï¼‰ã€‚
            éœ€è¦å¯¹å¤–æä¾› VPN/ä»£ç†/å…±äº«æœåŠ¡æ—¶ï¼Œè¯·åœ¨é˜²ç«å¢™/ç«¯å£è½¬å‘ä¸­æŒ‰éœ€æ”¾è¡Œç«¯å£ã€‚
            âš ï¸ é‡è¦æé†’
            æœ¬å›ºä»¶ä»…é€‚ç”¨äº AX3000T v1ã€‚åˆ·æœºæœ‰é£é™©ï¼Œè¯·ç¡®ä¿äº†è§£åˆ·æœºæµç¨‹ã€‚
            é¦–æ¬¡å¯ç”¨ AdGuardHome / Nginx HTTPS / TTYD ç­‰æœåŠ¡ï¼Œè¯·æ ¹æ®å®é™…éœ€æ±‚åœ¨ LuCI ä¸­å®Œæˆç«¯å£ä¸è¯ä¹¦/è®¿é—®æ§åˆ¶é…ç½®ã€‚
          files: |
            ${{ env.FIRMWARE_PATH }}/*
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: è·å–å½“å‰æ—¶é—´
        id: date
        run: echo "date=$(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')" >> $GITHUB_OUTPUT
      - name: ç¼–è¯‘æ€»ç»“
        if: always()
        run: |
          echo "========================================="
          echo "           ç¼–è¯‘æ€»ç»“æŠ¥å‘Š"
          echo "========================================="
          echo "çŠ¶æ€: ${{ env.COMPILE_SUCCESS == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
          echo "æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ç‰ˆæœ¬: OpenWrt 24.10.3"
          echo "è®¾å¤‡: å°ç±³AX3000T v1"
          echo "æ„å»º: #${{ github.run_number }}"
          if [ "${{ env.COMPILE_SUCCESS }}" == "true" ]; then
            echo "å›ºä»¶: ${{ env.FIRMWARE_PATH }}"
            echo "ğŸ‰ æ­å–œï¼å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            echo "ğŸ“¥ ä¸‹è½½åœ°å€: ${{ github.server_url }}/${{ github.repository }}/releases/latest"
          else
            echo "ğŸ˜ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"
          fi
          echo "========================================="
